name: Reusable Docker Build

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      environment:
        description: "GitHub Environment name"
        required: true
        type: string
      image_tags:
        description: "Comma or newline separated image tags"
        required: true
        type: string

jobs:
  build-image:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      REVALIDATE_TOKEN: ${{ secrets.REVALIDATE_TOKEN }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      ENV_ENABLE_TRACK: ${{ vars.ENABLE_TRACK }}
      ENV_REGION: ${{ vars.NEXT_PUBLIC_REGION }}
      ENV_WEBSITE_URL: ${{ vars.NEXT_PUBLIC_WEBSITE_URL }}
      ENV_FEC_API_TOKEN: ${{ secrets.FEC_API_TOKEN }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Env
        run: |
          set -euo pipefail
          touch .env
          echo NODE_ENV="production" >> .env
          echo REVALIDATE_TOKEN="$REVALIDATE_TOKEN" >> .env
          echo SENTRY_AUTH_TOKEN="$SENTRY_AUTH_TOKEN" >> .env
          echo NEXT_PUBLIC_ENABLE_TRACK="$ENV_ENABLE_TRACK" >> .env
          echo NEXT_PUBLIC_REGION="$ENV_REGION" >> .env
          echo NEXT_PUBLIC_WEBSITE_URL="$ENV_WEBSITE_URL" >> .env
          echo FEC_API_TOKEN="$ENV_FEC_API_TOKEN" >> .env

      - name: Build Docker image
        uses: docker/build-push-action@v6
        timeout-minutes: 10
        with:
          context: .
          push: false
          load: true
          tags: ${{ inputs.image_tags }}

      - name: Export image tar
        env:
          INPUT_IMAGE_TAGS: ${{ inputs.image_tags }}
        run: |
          set -euo pipefail
          tags=$(printf "%s" "$INPUT_IMAGE_TAGS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d')
          if [ -z "$tags" ]; then
            echo "No image tags provided"
            exit 1
          fi
          # Save all requested tags into one artifact, so downstream jobs can push any of them.
          printf "%s\n" "$tags" | xargs docker save -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: docker-image
          path: image.tar
