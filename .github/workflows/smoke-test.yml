name: Smoke Test

on:
  workflow_dispatch:

concurrency:
  group: smoke-test-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docker-smoke:
    name: Docker smoke test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      IMAGE_NAME: furrycons:ci
      CONTAINER_PORT: "3000"   # 容器内监听端口（Next 默认 3000）
      PATH_TO_TEST: "/about" # 冒烟测试路径（可改成 /about 等）

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          set -euo pipefail
          docker build -t "${IMAGE_NAME}" .

      - name: Run smoke test (container -> http)
        run: |
          set -euo pipefail

          # 启动容器：映射到宿主机随机端口，避免端口冲突
          CID=$(docker run -d -p 0:${CONTAINER_PORT} "${IMAGE_NAME}")

          cleanup() {
            echo "---- docker ps ----"
            docker ps -a || true
            echo "---- docker logs ----"
            docker logs "${CID}" || true
            echo "---- removing container ----"
            docker rm -f "${CID}" || true
          }
          trap cleanup EXIT

          # 读取宿主机映射端口
          HOST_PORT=$(docker inspect \
            --format='{{(index (index .NetworkSettings.Ports "'"${CONTAINER_PORT}"'/tcp") 0).HostPort}}' \
            "${CID}")

          echo "Container started: ${CID}"
          echo "Mapped port: 127.0.0.1:${HOST_PORT} -> ${CONTAINER_PORT}"
          echo "Testing path: ${PATH_TO_TEST}"

          # 等待服务就绪：最多 60 秒
          for i in {1..60}; do
            if curl -fsS "http://127.0.0.1:${HOST_PORT}${PATH_TO_TEST}" >/dev/null; then
              echo "smoke ok: ${PATH_TO_TEST}"
              exit 0
            fi
            sleep 1
            if [ "$i" -eq 60 ]; then
              echo "smoke failed: ${PATH_TO_TEST}"
              exit 1
            fi
          done
