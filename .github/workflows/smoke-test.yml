name: Smoke Test

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: Select deployment environment for smoke test
        required: true
        type: environment
        default: Prod-CN

concurrency:
  group: smoke-test-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  build-image:
    uses: ./.github/workflows/reusable-docker-build.yml
    with:
      environment: ${{ inputs.target_environment }}
      image_tags: furrycons:ci

  docker-smoke:
    uses: ./.github/workflows/reusable-smoke-test.yml
    needs: build-image
    with:
      environment: ${{ inputs.target_environment }}
      image_name: furrycons:ci
      artifact_name: docker-image
      container_port: "3000"
      path_to_test: /about
      timeout_minutes: 15
